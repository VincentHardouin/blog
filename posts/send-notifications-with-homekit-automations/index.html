<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><title itemprop=name>Send notifications with HomeKit automations | Vincent Hardouin</title>
<meta property='og:title' content='Send notifications with HomeKit automations | Vincent Hardouin'><meta name=twitter:title content='Send notifications with HomeKit automations | Vincent Hardouin'><meta itemprop=name content='Send notifications with HomeKit automations | Vincent Hardouin'><meta name=application-name content='Send notifications with HomeKit automations | Vincent Hardouin'><meta property='og:site_name' content><meta name=description content='Blog de tutorials, humeurs, … sur des sujets tech.'><meta itemprop=description content='Blog de tutorials, humeurs, … sur des sujets tech.'><meta property='og:description' content='Blog de tutorials, humeurs, … sur des sujets tech.'><meta name=twitter:description content='Blog de tutorials, humeurs, … sur des sujets tech.'><base href=https://vincenthardouin.dev/posts/send-notifications-with-homekit-automations/><link rel=canonical href=https://vincenthardouin.dev/posts/send-notifications-with-homekit-automations/ itemprop=url><meta name=url content='https://vincenthardouin.dev/posts/send-notifications-with-homekit-automations/'><meta name=twitter:url content='https://vincenthardouin.dev/posts/send-notifications-with-homekit-automations/'><meta property='og:url' content='https://vincenthardouin.dev/posts/send-notifications-with-homekit-automations/'><meta property='og:locale' content='fr'><meta name=language content><link rel=alternate hreflang=fr href=https://vincenthardouin.dev/posts/send-notifications-with-homekit-automations/ title><meta property='og:image' content='https://vincenthardouin.dev/card/send-notifications-with-homekit-automations.png'><meta itemprop=image content='https://vincenthardouin.dev/card/send-notifications-with-homekit-automations.png'><meta name=twitter:card content='summary_large_image'><meta name=twitter:image content='https://vincenthardouin.dev/card/send-notifications-with-homekit-automations.png'><link rel=preload href=/fonts/OpenSans-VariableFont_wdth,wght.ttf as=font type=font/ttf crossorigin><link rel=preload href=/fonts/Roboto-Regular.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/scss/main.min.9f3b92cf8cbab60f5cd732ff676e9ff1e0a9d168cf1386324186fd13884cb2ba9cec72672c9a3ca2a3718518b24b8016bad18a5f4e9c6acdc13f8287bee4e7c5.css integrity='sha512-nzuSz4y6tg9c1zL/Z26f8eCp0WjPE4YyQYb9E4hMsrqc7HJnLJo8oqNxhRiyS4AWutGKX06cas3BP4KHvuTnxQ=='><link rel=icon type=image/x-icon href=/favicon.ico><link rel=sitemap type=application/xml title=Sitemap href=https://vincenthardouin.dev/sitemap.xml><script type=text/javascript src=/app.dcb683997da9136ea54c7b787eaf0b74f4156caa340bfd0b4d903e7f55f5a74bfbdcddb97f2d41e32de2e879c48466f34d9dd0923bd2266d00cb9e178c6c3c93.js integrity='sha512-3LaDmX2pE26lTHt4fq8LdPQVbKo0C/0LTZA+f1X1p0v73N25fy1B4y3i6HnEhGbzTZ3QkjvSJm0Ay54XjGw8kw==' defer></script><script type=text/javascript src=https://analytics.vincenthardouin.dev/js/script.js async defer data-domain=vincenthardouin.dev></script></head><body><header class=header><a class='flex header__title' href=/>Vincent Hardouin</a><nav class=header__navbar><ul class=navbar><li><a class=navbar__item href=/>Accueil</a></li><li><a class=navbar__item href=/projects>Projets</a></li><li><a class=navbar__item href=/a-propos>À propos</a></li></ul></nav><div class='flex phantom'></div></header><div id=content><article role=article class=post><div class=post__container><div class=post__date>15/12/2023</div><h1 class=post__title>Send notifications with HomeKit automations</h1><aside class=post__table-of-contents><nav id=TableOfContents><ul><li><a href=#context>Context</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#receiving-notifications-with-ntfy>Receiving notifications with NTFY</a><ul><li><a href=#free-tier>Free Tier</a></li><li><a href=#self-hosted>Self-hosted</a></li><li><a href=#download-the-ntfy-application>Download the Ntfy application</a></li><li><a href=#send-a-notification>Send a notification</a></li></ul></li><li><a href=#create-an-automation>Create an automation</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav><svg class="toc-marker" width="200" height="400"><path stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)"/></svg></aside><article class='post__content slide-enter-content'><h2 id=context>Context</h2><p>Apple has been offering Shortcuts since 2018. It&rsquo;s an app that lets you create/use automations on iOS, macOS
and more recently for HomeKit by launching on the Home Hub.
However, because these automations run directly on the Home Hub, they cannot
benefit from third-party applications such as PushCut, Controller, Scriptable, which simplify these processes.</p><p>So we&rsquo;re going to explore a method of getting around this limitation and sending notifications via
HomeKit automations.</p><h2 id=prerequisites>Prerequisites</h2><p>A HomeKit Hub (Apple TV, HomePod, iPad)</p><h2 id=receiving-notifications-with-ntfy>Receiving notifications with NTFY</h2><p>In my idea, I wanted the people involved in a notification to receive one.
For example, if the last person to leave the house forgot to close the windows, then they&rsquo;d receive a
notification.</p><p>In practice, it&rsquo;s not possible to do this with HomeKit automations, as there&rsquo;s no way of knowing who triggered the
automation.
who triggered the automation.</p><p>So we&rsquo;re going to create an automation that will send a notification to everyone in the house.</p><p>Ideally, the notification should be sent via an HTTP request. That&rsquo;s ideal, because there&rsquo;s
service that lets you do just that: <a href=https://ntfy.org/>Ntfy</a>.</p><h3 id=free-tier>Free Tier</h3><p>Ntfy&rsquo;s free plan allows you to send 250 notifications per month, more than enough for our purposes. If you&rsquo;d
support the project, you can subscribe or sponsor it.</p><p>The limitation of the free plan is that you can&rsquo;t protect your topics.
You&rsquo;ll need to generate a topic with a random name and, above all, never publish personal information on it.
on it.</p><h3 id=self-hosted>Self-hosted</h3><p>If you prefer, you can also host your own instance of Ntfy, following the instructions in
<a href=https://docs.ntfy.sh/install/>Ntfy documentation</a>.</p><p>Be sure to protect your
instance, <a href=https://docs.ntfy.sh/config/#access-control>by enabling access controls</a>.</p><h3 id=download-the-ntfy-application>Download the Ntfy application</h3><p>Once you&rsquo;ve created your topic, you can download the Ntfy application onto your phone, then subscribe to your topic.
to your topic.</p><h3 id=send-a-notification>Send a notification</h3><p>You can then try sending a notification from a terminal with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Title: Notification title&#39;</span> -d <span class=s1>&#39;This is a test&#39;</span> https://ntfy.sh/&lt;topic&gt;
</span></span></code></pre></div><p>Now that we know how to receive notifications, we can create our own automation to send this
notification.</p><h2 id=create-an-automation>Create an automation</h2><p>We go to Home app, then to the Automation tab, then to the + button in the top right-hand corner.</p><p>For the example, we&rsquo;ll choose the trigger &ldquo;When the last person leaves the house&rdquo;.
We then want to make a shortcut, so at the very bottom we choose &ldquo;Convert to shortcut&rdquo;.
Then we add the action &ldquo;Retrieve a web page&rdquo;.</p><p>Then we choose the POST method, and there&rsquo;s the drama.
We can see that Apple only offers JSON, a form or files, but not plain text.
so we&rsquo;re in a bit of a bind.</p><p>Fortunately, Ntfy has foreseen this case with the possibility of calling the <code>/</code> resource with JSON.</p><p>Our previous curl thus becomes :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST -d <span class=s1>&#39;{ &#34;topic:&#34;&lt;topic&gt;&#34;, &#34;title&#34;: &#34;Notification title&#34;, &#34;message&#34;: &#34;This is a test&#34; }&#39;</span> https://ntfy.sh/
</span></span></code></pre></div><p>Note that the topic is now in JSON.</p><p>We can now finalize our action:</p><p><img src=action-recuperer-une-page-web.png alt='Get contents of' loading=lazy></p><h2 id=conclusion>Conclusion</h2><p>Ntfy has enabled us to send notifications from HomeKit automations. We can also use it from Shortcuts
Shortcuts, and remains an interesting solution for sending notifications from a script.</p><p>Don&rsquo;t hesitate to support the project if you use it!</p></article><div class=post__actions><div><a href=/posts/envoyer-des-notifications-avec-les-automations-homekit/>Précédent</a></div><a href=/>Retour à la page d'accueil</a><div><a href=/posts/switch-to-previous-branches-with-git/>Suivant</a></div></div></div><script type=text/javascript>function throttle(e,t){let n=0;return function(){const s=new Date;s-n>=t&&(e(),n=s)}}window.addEventListener("scroll",throttle(updateTOC,500)),window.addEventListener("resize",init);const toc=document.getElementById("TableOfContents").firstElementChild,headings=document.querySelectorAll("h2, h3, h4"),TOP_MARGIN=.1,BOTTOM_MARGIN=.1,tocItems=[].slice.call(toc.querySelectorAll("li")).map(function(e){const t=e.querySelector("a"),n=document.getElementById(t.getAttribute("href").slice(1));return{listItem:e,anchor:t,target:n}}).filter(e=>e.target!==void 0);function updateTOC(){const e=window.innerHeight;tocItems.forEach((t,n)=>{const{top:s,bottom:o}=getHeadingPositionOnViewport(n),i=o>=e*TOP_MARGIN&&s<e*(1-BOTTOM_MARGIN);i?t.anchor.classList.add("active"):t.anchor.classList.remove("active")}),sync()}function getHeadingPositionOnViewport(e){const n=headings[e].getBoundingClientRect().top,s=e===headings.length-1;let t;return s?t=headings[e].parentElement.getBoundingClientRect().bottom:t=headings[e+1].getBoundingClientRect().top,{top:n,bottom:t}}let pathLength,lastPathStart,lastPathEnd;function init(){drawTOCPath(),updateTOC()}init();function drawTOCPath(){const t=document.querySelector(".toc-marker path"),e=[];let n;tocItems.forEach((s,o)=>{const i=s.anchor.offsetLeft-5,a=s.anchor.offsetTop,r=s.anchor.offsetHeight;o===0?(e.push("M",i,a,"L",i,a+r),s.pathStart=0):(n!==i&&e.push("L",n,a),e.push("L",i,a),t.setAttribute("d",e.join(" ")),s.pathStart=t.getTotalLength()||0,e.push("L",i,a+r)),n=i,t.setAttribute("d",e.join(" ")),s.pathEnd=t.getTotalLength()}),pathLength=t.getTotalLength()}function sync(){const e=document.querySelector(".toc-marker path"),n=tocItems.filter(({anchor:e})=>e.classList.contains("active")),t=Math.min(...n.map(e=>e.pathStart),pathLength),s=Math.max(...n.map(e=>e.pathEnd),0);n.length>0&&t<s?(t!==lastPathStart||s!==lastPathEnd)&&(e.setAttribute("stroke-dashoffset","1"),e.setAttribute("stroke-dasharray","1, "+t+", "+(s-t)+", "+pathLength),e.setAttribute("opacity",1)):e.setAttribute("opacity",0)}</script></article></div><footer><script src=https://giscus.app/client.js data-repo=VincentHardouin/blog data-repo-id='MDEwOlJlcG9zaXRvcnk0MDM2OTk5MTk=' data-category=Announcements data-category-id=DIC_kwDOGA_4z84CWyji data-mapping=title data-strict=0 data-reactions-enabled=1 data-input-position=bottom data-emit-metadata=0 data-lang=fr data-loading=lazy data-theme=preferred_color_scheme crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by giscus.</noscript></footer></body></html>