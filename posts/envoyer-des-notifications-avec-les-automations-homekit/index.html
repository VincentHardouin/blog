<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Envoyer des notifications avec les automations HomeKit | Vincent Hardouin</title>
<meta property="og:title" content="Envoyer des notifications avec les automations HomeKit | Vincent Hardouin"><meta name=twitter:title content="Envoyer des notifications avec les automations HomeKit | Vincent Hardouin"><meta itemprop=name content="Envoyer des notifications avec les automations HomeKit | Vincent Hardouin"><meta name=application-name content="Envoyer des notifications avec les automations HomeKit | Vincent Hardouin"><meta property="og:site_name" content><meta name=description content="Blog de tutorials, humeurs, … sur des sujets tech."><meta itemprop=description content="Blog de tutorials, humeurs, … sur des sujets tech."><meta property="og:description" content="Blog de tutorials, humeurs, … sur des sujets tech."><meta name=twitter:description content="Blog de tutorials, humeurs, … sur des sujets tech."><base href=https://vincenthardouin.dev/posts/envoyer-des-notifications-avec-les-automations-homekit/><link rel=canonical href=https://vincenthardouin.dev/posts/envoyer-des-notifications-avec-les-automations-homekit/ itemprop=url><meta name=url content="https://vincenthardouin.dev/posts/envoyer-des-notifications-avec-les-automations-homekit/"><meta name=twitter:url content="https://vincenthardouin.dev/posts/envoyer-des-notifications-avec-les-automations-homekit/"><meta property="og:url" content="https://vincenthardouin.dev/posts/envoyer-des-notifications-avec-les-automations-homekit/"><meta property="og:locale" content="fr"><meta name=language content><meta itemprop=image content="https://vincenthardouin.dev/"><meta property="og:image" content="https://vincenthardouin.dev/"><meta name=twitter:image content="https://vincenthardouin.dev/"><meta name=twitter:image:src content="https://vincenthardouin.dev/"><link rel=preload href=/fonts/OpenSans-VariableFont_wdth,wght.ttf as=font type=font/ttf crossorigin><link rel=preload href=/fonts/Roboto-Regular.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/scss/main.min.1df656ba36ea152bf97e5feb402b9ff804ff350a6f8613ed5d07c39aa66cf8a61a7d3e9afbbc3e27d4ddd893a46cc1d65d9877c4a40ed80c9aae67665f06b113.css integrity='sha512-HfZWujbqFSv5fl/rQCuf+AT/NQpvhhPtXQfDmqZs+KYafT6a+7w+J9Td2JOkbMHWXZh3xKQO2AyarmdmXwaxEw=='><link rel=icon type=image/x-icon href=/favicon.ico><link rel=sitemap type=application/xml title=Sitemap href=https://vincenthardouin.dev/sitemap.xml><script type=text/javascript src=/app.64d79f0041b25c855ed91588aa9086df52feddfd8332078ffc1d0434f29eb525ab33a151c0627829e4bcea5867a397fa885e25b43ed694c4694205176b217299.js integrity='sha512-ZNefAEGyXIVe2RWIqpCG31L+3f2DMgeP/B0ENPKetSWrM6FRwGJ4KeS86lhno5f6iF4ltD7WlMRpQgUXayFymQ==' defer></script><script type=text/javascript src=https://analytics.vincenthardouin.dev/js/script.js async defer data-domain=vincenthardouin.dev></script></head><body><header class=header><a class='flex header__title' href=/>Vincent Hardouin</a><nav class=header__navbar><ul class=navbar><li><a class=navbar__item href=/>Accueil</a></li><li><a class=navbar__item href=/a-propos>À propos</a></li></ul></nav><div class='flex phantom'></div></header><div id=content><article role=article class=post><div class=post__banner></div><div class=post__container><div class=post__date>15/12/2023</div><h1 class=post__title>Envoyer des notifications avec les automations HomeKit</h1><aside><nav id=TableOfContents><ul><li><a href=#contexte>Contexte</a></li><li><a href=#prérequis>Prérequis</a></li><li><a href=#recevoir-des-notifications>Recevoir des notifications</a><ul><li><a href=#plan-gratuit-de-ntfy>Plan Gratuit de Ntfy</a></li><li><a href=#self-hosted>Self-hosted</a></li><li><a href=#télécharger-lapplication-ntfy>Télécharger l&rsquo;application Ntfy</a></li><li><a href=#envoi-dune-notification>Envoi d&rsquo;une notification</a></li></ul></li><li><a href=#créer-une-automation>Créer une automation</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><article class=post__content><h2 id=contexte>Contexte</h2><p>Apple propose Shortcuts depuis 2018. C&rsquo;est une application qui permet de créer/utiliser des automations sur iOS, macOS
et plus récemment pour HomeKit en se lançant sur le Hub de la maison.
Cependant, du fait que ces automatisations s&rsquo;exécutent directement sur le Hub de la maison, elles ne peuvent pas
bénéficier des applications tierces telles que PushCut, Controller, Scriptable, qui simplifient ces processus.</p><p>Nous allons donc explorer une méthode pour contourner cette limitation et envoyer des notifications via les
automatisations HomeKit.</p><h2 id=prérequis>Prérequis</h2><p>Un Hub HomeKit (Apple TV, HomePod, iPad)</p><h2 id=recevoir-des-notifications>Recevoir des notifications</h2><p>Dans mon idée, je voulais que les personnes concernées par une notification en reçoivent une.
Par exemple, si la dernière personne qui part de la maison a oublié de ferme les fenêtres, alors elle reçoit une
notification.</p><p>Dans les faits, il n&rsquo;est pas possible de faire cela avec les automations HomeKit, car il n&rsquo;est pas possible de savoir
qui a déclenché l&rsquo;automation.</p><p>Nous allons donc créer une automation qui va envoyer une notification à toutes les personnes de la maison.</p><p>Pour envoyer la notification, l&rsquo;idéal serait de pouvoir le faire via une requête HTTP. Cela tombe bien, car il existe
un service qui permet de faire cela : <a href=https://ntfy.org/>Ntfy</a>.</p><h3 id=plan-gratuit-de-ntfy>Plan Gratuit de Ntfy</h3><p>Le plan gratuit de Ntfy autorise l&rsquo;envoi de 250 notifications par mois, amplement suffisant pour notre usage. Si vous
souhaitez soutenir le projet, vous pouvez prendre un abonnement ou le sponsoriser.</p><p>La limitation du plan gratuit est de ne pas pouvoir protéger les topics.
Il faut donc générer un topic avec un nom aléatoire et surtout, il ne faudra jamais publier d&rsquo;information personnelle
dessus.</p><h3 id=self-hosted>Self-hosted</h3><p>Si vous préférez, vous pouvez aussi héberger votre propre instance de Ntfy, en suivant les instructions de
<a href=https://docs.ntfy.sh/install/>la documentation de Ntfy</a>.</p><p>Attention à bien protéger votre
instance, <a href=https://docs.ntfy.sh/config/#access-control>en activant les contrôles d&rsquo;accès</a>.</p><p>Personnellement, j&rsquo;ai ajouté <a href=https://www.authelia.com/>Authelia</a> par-dessus, pour en plus empêcher l&rsquo;accès à l'
interface web.</p><h3 id=télécharger-lapplication-ntfy>Télécharger l&rsquo;application Ntfy</h3><p>Une fois votre topic créé, vous pouvez télécharger l&rsquo;application Ntfy sur votre téléphone, puis vous devez vous abonner
à votre topic.</p><h3 id=envoi-dune-notification>Envoi d&rsquo;une notification</h3><p>Vous pouvez ensuite essayer d&rsquo;envoyer une notification depuis un terminal avec la commande suivante :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST -H <span class=s1>&#39;Title: Titre de la notification&#39;</span> -d <span class=s1>&#39;Ceci est un test &#39;</span> https://ntfy.sh/&lt;topic&gt;
</span></span></code></pre></div><p>Maintenant, nous savons recevoir des notifications, nous allons pouvoir créer notre automation qui envoie cette
notification.</p><h2 id=créer-une-automation>Créer une automation</h2><p>Nous allons sur l&rsquo;application Home, puis sur l&rsquo;onglet Automation, puis sur le bouton + en haut à droite.</p><p>Pour l&rsquo;exemple, nous allons choisir le déclencheur &ldquo;Quand la dernière personne quitte la maison&rdquo;.
Nous voulons ensuite faire un shortcut, donc tout en bas, nous choisissons &ldquo;Convertir en raccourci&rdquo;.
Puis, nous ajoutons l&rsquo;action &ldquo;Récupérer une page web&rdquo;.</p><p>Nous choisissons ensuite la méthode POST, et là le drame.
Nous pouvons voir qu&rsquo;Apple propose uniquement du JSON, un formulaire ou des fichiers, mais pas de texte brut, nous
sommes bien embêtés.</p><p>Heureusement, Ntfy a prévu ce cas avec la possibilité d&rsquo;appeler la ressource <code>/</code> avec du JSON.</p><p>Notre curl précédent devient donc :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST -d <span class=s1>&#39;{ &#34;topic:&#34;&lt;topic&gt;&#34;, &#34;title&#34;: &#34;Titre de la notification&#34;, &#34;message&#34;: &#34;Ceci est un test&#34; }&#39;</span> https://ntfy.sh/
</span></span></code></pre></div><p>Notez que le topic est désormais dans le JSON.</p><p>Nous pouvons donc finaliser notre action :</p><p><img src=action-recuperer-une-page-web.png alt="Action Récupérer une page web"></p><h2 id=conclusion>Conclusion</h2><p>Ntfy, nous a permis d&rsquo;envoyer des notifications depuis les automations HomeKit. Nous pouvons aussi nous en servir depuis
les Shortcuts, et reste une solution intéressante pour envoyer des notifications depuis un script.</p><p>N&rsquo;hésitez pas à soutenir le projet si vous l&rsquo;utilisez !</p></article></div></article></div><footer><script src=https://giscus.app/client.js data-repo=VincentHardouin/blog data-repo-id='MDEwOlJlcG9zaXRvcnk0MDM2OTk5MTk=' data-category=Announcements data-category-id=DIC_kwDOGA_4z84CWyji data-mapping=title data-strict=0 data-reactions-enabled=1 data-input-position=bottom data-emit-metadata=0 data-lang=fr data-loading=lazy data-theme=preferred_color_scheme crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the comments powered by giscus.</noscript></footer></body></html>