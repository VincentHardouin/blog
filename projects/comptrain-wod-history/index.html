<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><title itemprop=name>Comptrain WOD history | Vincent Hardouin</title>
<meta property='og:title' content='Comptrain WOD history | Vincent Hardouin'><meta name=twitter:title content='Comptrain WOD history | Vincent Hardouin'><meta itemprop=name content='Comptrain WOD history | Vincent Hardouin'><meta name=application-name content='Comptrain WOD history | Vincent Hardouin'><meta property='og:site_name' content><meta name=description content='Blog de tutorials, humeurs, … sur des sujets tech.'><meta itemprop=description content='Blog de tutorials, humeurs, … sur des sujets tech.'><meta property='og:description' content='Blog de tutorials, humeurs, … sur des sujets tech.'><meta name=twitter:description content='Blog de tutorials, humeurs, … sur des sujets tech.'><base href=https://vincenthardouin.dev/projects/comptrain-wod-history/><link rel=canonical href=https://vincenthardouin.dev/projects/comptrain-wod-history/ itemprop=url><meta name=url content='https://vincenthardouin.dev/projects/comptrain-wod-history/'><meta name=twitter:url content='https://vincenthardouin.dev/projects/comptrain-wod-history/'><meta property='og:url' content='https://vincenthardouin.dev/projects/comptrain-wod-history/'><meta property='og:locale' content='fr'><meta name=language content><link rel=alternate hreflang=fr href=https://vincenthardouin.dev/projects/comptrain-wod-history/ title><meta property='og:image' content='https://vincenthardouin.dev/card/comptrain-wod-history.png'><meta itemprop=image content='https://vincenthardouin.dev/card/comptrain-wod-history.png'><meta name=twitter:card content='summary_large_image'><meta name=twitter:image content='https://vincenthardouin.dev/card/comptrain-wod-history.png'><link rel=preload href=/fonts/OpenSans-VariableFont_wdth,wght.ttf as=font type=font/ttf crossorigin><link rel=preload href=/fonts/Roboto-Regular.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/scss/main.min.bc70f936fff493f05b1123d00aa7593c1cba29b5d94eff22f4df3462beedf87559a2b6686cf196cf9dc56840366b7bf5dbe99804f935e4fc449645dd66ed1104.css integrity='sha512-vHD5Nv/0k/BbESPQCqdZPBy6KbXZTv8i9N80Yr7t+HVZorZobPGWz53FaEA2a3v12+mYBPk15PxElkXdZu0RBA=='><link rel=icon type=image/x-icon href=/favicon.ico><link rel=sitemap type=application/xml title=Sitemap href=https://vincenthardouin.dev/sitemap.xml><script type=text/javascript src=/app.9b550ea8bed0ab5d6fb58894824d9a790f3d1b1a6e3843b736db8c5669dddaa707d7170e4c0379e112564bcb42d05b59e170667b146a49fcd8081fd63819bb39.js integrity='sha512-m1UOqL7Qq11vtYiUgk2aeQ89GxpuOEO3NtuMVmnd2qcH1xcOTAN54RJWS8tC0FtZ4XBmexRqSfzYCB/WOBm7OQ==' defer></script><script type=text/javascript src=https://analytics.vincenthardouin.dev/js/script.js async defer data-domain=vincenthardouin.dev></script><script type=module src=/turbo.esm.7-3-0.js async defer></script></head><body><header class=header><a class='flex header__title' href=/>Vincent Hardouin</a><nav class=header__navbar><ul class=navbar><li><a class=navbar__item href=/>Accueil</a></li><li><a class=navbar__item href=/projects>Projets</a></li><li><a class=navbar__item href=/a-propos>À propos</a></li></ul></nav><div class='flex phantom'></div></header><div id=content><main role=main class=page><h1 class=page__title>Comptrain WOD history</h1><div class=page__content><h2 id=introduction>Introduction</h2><p>J&rsquo;ai récemment créé un projet pour historiser tous les WOD proposés par <a href=https://comptrain.co/>Comptrain</a>.</p><p>La programmation de Comptrain est l&rsquo;une des programmations de Crossfit les plus reconnues dans son milieu,
notamment grâce à la renommée de son créateur <a href=https://benbergeron.com/about/>Ben Bergeron</a>
qui a entre autres entrainé Mathew Fraser 5 fois vainqueur des CrossFit Games.</p><p>L&rsquo;équipe de Comptrain propose une programmation gratuite. Elle est constituée d&rsquo;un WOD tous les jours de la semaine
sauf le jeudi et le dimanche, qui sont des &ldquo;REST DAY&rdquo;.</p><p>Cependant, l&rsquo;historique des WODS n&rsquo;est pas disponible.
Ce qui devient problématique quand vous souhaitez vous entrainer le jeudi et/ou le dimanche
et que vous n&rsquo;avez pas pris une capture d&rsquo;écran la veille. Vous vous retrouvez sans entrainement
et surtout vous n&rsquo;allez pas suivre la programmation.</p><h2 id=projet>Projet</h2><p>À force de subir ce problème, j&rsquo;ai décidé d&rsquo;historiser les WODs en les enregistrant dans une
base de données.</p><p>Je suis parti sur une architecture contenant <strong>une API</strong> et un site statique.</p><p>L&rsquo;API a comme rôle :</p><ul><li>de récupérer grâce à un <a href=https://en.wikipedia.org/wiki/Cron>CRON</a> les WODs</li><li>fournir un endpoint permettant de récupérer tous les WODs</li></ul><p>Le <strong>site statique</strong> quant à lui doit appeler l&rsquo;endpoint et afficher tous les WODs.</p><p>La stack de l&rsquo;API se compose de :</p><ul><li><a href=https://www.fastify.io/>Fastify</a> comme serveur NodeJS, que je trouve pratique et simple d&rsquo;utilisation.</li><li><a href=https://www.prisma.io/>Prisma</a> comme ORM. J&rsquo;ai choisi ce dernier, car je ne le connaissais pas et que j&rsquo;en avais
entendu du bien. Naturellement, j&rsquo;ai voulu l&rsquo;essayer. Il s&rsquo;avère que pour l&rsquo;usage que j&rsquo;en fais, je ne l&rsquo;ai pas essayé
dans ses retranchements.</li><li><a href=https://www.postgresql.org/>PostgreSQL</a> comme base de données.</li></ul><p>Enfin, pour le site statique, je suis parti sur une application <a href=https://nuxtjs.org/>NuxtJS</a>, qui permet la
génération statique du site.</p><p>Pour l&rsquo;hébergement, nous nous retrouvons avec l&rsquo;API qui tourne sur mon VPS et le site statique hébergé sur GitHub Pages.
La génération du site est déclenchée chaque jour grâce à une GitHub Action
via <a href=https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule>un event schedule</a></p><p>La solution fonctionne, la base comporte désormais 180 WODs, mais plusieurs éléments peuvent être améliorés.</p><h2 id=changement-darchitecture>Changement d&rsquo;architecture</h2><p>Nous avons dans cette configuration une base de données et une API qui tourne 24h/24 dans l&rsquo;attente d&rsquo;une
insertion et une lecture de toute la table tous les jours. Cela <strong>consomme des ressources inutilement</strong>.</p><p>Nous pouvons alors nous demander si cela convient avec les besoins futurs.</p><h3 id=perspective-dévolution>Perspective d&rsquo;évolution</h3><h4 id=volumétrie>Volumétrie</h4><p>Intéressons-nous à la volumétrie de la base de données.
Il y a moins de 365 WODs/an : <strong>365 wods/an * 100 ans = 36 500 wods</strong>.
Nous pouvons dire que la volumétrie globale n&rsquo;excédera jamais les 100 000 éléments.</p><h4 id=amélioration>Amélioration</h4><p>Ensuite, l&rsquo;unique amélioration que j&rsquo;envisage est la recherche par mouvements (squats, push-ups, pull-ups, …) pour
choisir d&rsquo;en avoir certains et d&rsquo;autres non.</p><p>En connaissant cette volumétrie et l&rsquo;amélioration que je souhaite faire, nous nous rendons compte que n&rsquo;importe quelle
base de données et/ou langage est capable de répondre à ces besoins.</p><h3 id=déroulement>Déroulement</h3><p>Un dimanche, j&rsquo;ai fait le choix de réduire toute cette consommation.</p><p>L&rsquo;idée que j&rsquo;ai est de retirer la dépendance à mon VPS et que tout soit directement hébergé dans le repository
GitHub.</p><p>Pour cela, il me fallait changer de base de données et changer la façon dont les données étaient récupérées au moment de
la génération du site statique.</p><h3 id=réalisation>Réalisation</h3><h4 id=migration-de-la-base-de-données>Migration de la base de données</h4><p>Dans un premier temps, j&rsquo;ai migré de PostgreSQL vers SQLite, une base de données bien plus légère comme son nom
l&rsquo;indique. Les avantages de SQLite sont les suivants :</p><ul><li>très léger</li><li>la base de données est stockée directement dans un fichier, ce qui va dans l&rsquo;optique d&rsquo;être stocké dans le repository</li><li>un connecteur intégré à Prisma existe, ce qui me facilite la migration</li></ul><p>Pour faire la migration :</p><ol><li>Exporter la table dans un fichier CSV :</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>COPY</span><span class=w> </span><span class=n>workouts</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;tmp/workouts_db.csv&#39;</span><span class=w> </span><span class=k>DELIMITER</span><span class=w> </span><span class=s1>&#39;,&#39;</span><span class=w> </span><span class=n>CSV</span><span class=w> </span><span class=n>HEADER</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=2><li>Importer la table dans SQLite :</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>.import workouts_db.csv workouts
</span></span></code></pre></div><p>Du côté de Prisma, comme indiqué
dans <a href=https://www.prisma.io/docs/concepts/components/prisma-migrate/prisma-migrate-limitations-issues>la documentation</a> :</p><ol><li>Dans le fichier <code>schema.prisma</code>, il faut changer le provider et l&rsquo;url.</li><li>Supprimer le dossier <code>prisma/migrations</code></li><li>Rejouer les migrations avec <code>prisma migrate dev</code></li></ol><p>Cependant, lorsque j&rsquo;ai voulu récupérer les données via Prisma, cela ne fonctionnait pas.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>node -p <span class=s2>&#34;const { PrismaClient } = require(&#39;@prisma/client&#39;); 
</span></span></span><span class=line><span class=cl><span class=s2>new PrismaClient()
</span></span></span><span class=line><span class=cl><span class=s2>  .workout
</span></span></span><span class=line><span class=cl><span class=s2>  .findMany({ select: { title: true, createdAt: true }})
</span></span></span><span class=line><span class=cl><span class=s2>  .then(console.log);&#34;</span>
</span></span></code></pre></div><p>L&rsquo;erreur en question :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Inconsistent column data: Conversion failed: input contains invalid characters
</span></span></code></pre></div><p>Je me suis alors dit que le problème venait du format des dates. Pour vérifier cela, j&rsquo;ai d&rsquo;abord demandé les WODs sans
la date de création.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>node -p <span class=s2>&#34;const { PrismaClient } = require(&#39;@prisma/client&#39;); 
</span></span></span><span class=line><span class=cl><span class=s2>new PrismaClient()
</span></span></span><span class=line><span class=cl><span class=s2>  .workout
</span></span></span><span class=line><span class=cl><span class=s2>  .findMany({ select: { title: true }})
</span></span></span><span class=line><span class=cl><span class=s2>  .then(console.log);&#34;</span>
</span></span></code></pre></div><p>Là je constate que ça fonctionne.</p><p>En effet, les dates étaient sous le format <a href=https://en.wikipedia.org/wiki/ISO_8601>ISO 8601</a>
(ex: 2022-01-07 14:43:00.432).
Seulement, en essayant d&rsquo;insérer des données à l&rsquo;aide de Prisma, nous pouvons voir que
Prisma insère des dates sous le format <a href=https://en.wikipedia.org/wiki/Unix_time>UNIX Epoch</a> (ex: 1641566580) :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>node -p <span class=s2>&#34;const { PrismaClient } = require(&#39;@prisma/client&#39;); 
</span></span></span><span class=line><span class=cl><span class=s2>new PrismaClient()
</span></span></span><span class=line><span class=cl><span class=s2>  .workout
</span></span></span><span class=line><span class=cl><span class=s2>  .create({ 
</span></span></span><span class=line><span class=cl><span class=s2>    data: { title: &#39;test&#39;, content: &#39;&#39;},
</span></span></span><span class=line><span class=cl><span class=s2>    select: { createdAt: true }
</span></span></span><span class=line><span class=cl><span class=s2>  })
</span></span></span><span class=line><span class=cl><span class=s2>  .then(console.log);&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{</span> createdAt: 2022-07-17T15:51:05.791Z <span class=o>}</span>
</span></span></code></pre></div><p>Et en base nous retrouvons :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=s2>&#34;createdAt&#34;</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>workouts</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1658073065791</span><span class=w>
</span></span></span></code></pre></div><p>Il m&rsquo;a alors suffi d&rsquo;importer les données dans une table temporaire puis de les importer dans la table finale en
convertissant les dates :</p><ol><li>Je supprime la base précédemment créée :</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>workouts</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=2><li>Je réimporte les données dans une table temporaire</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>.</span><span class=n>import</span><span class=w> </span><span class=n>workouts_db</span><span class=p>.</span><span class=n>csv</span><span class=w> </span><span class=s2>&#34;workouts-tmp&#34;</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>J&rsquo;insère les données dans la table <code>workouts</code> en me basant sur la table <code>workouts_temp</code> mais en convertissant les
dates :</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>workouts</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>content</span><span class=p>,</span><span class=w> </span><span class=n>createdAt</span><span class=p>,</span><span class=w> </span><span class=n>updatedAt</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>content</span><span class=p>,</span><span class=w> </span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%s&#39;</span><span class=p>,</span><span class=n>createdAt</span><span class=p>),</span><span class=w> </span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%s&#39;</span><span class=p>,</span><span class=w> </span><span class=n>updatedAt</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=s2>&#34;workouts-tmp&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=4><li>Je supprime la table temporaire</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>drop</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=s2>&#34;workouts-tmp&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Nous avons désormais migré notre base de PostgreSQL vers SQLite, nous pouvons maintenant inclure notre base dans le
repository.</p><h4 id=migration-de-lapi>Migration de l&rsquo;API</h4><p>Pour ce qui est de l&rsquo;API, au lieu qu&rsquo;elle tourne en permanence, j&rsquo;ai décidé de la lancer uniquement au moment où le site
se génère.</p><p>Je n&rsquo;ai pas
utilisé <a href=https://docs.github.com/en/actions/using-containerized-services/about-service-containers>les services des GitHub Actions</a>
étant limités à des images Docker dont je n&rsquo;ai pas envie dans mon idée de moins de dépendance possible.</p><p>Je me suis tourné vers la modification de la génération du site statique : pour ajouter le lancement de l&rsquo;API dans un
processus en tâche de fond.</p><p>Voilà le résultat :</p><pre tabindex=0><code>(cd api &amp;&amp; npm start &amp;); cd webapp &amp;&amp; npm run generate
</code></pre><p>Vous pouvez trouver la GitHub Action complète
ici : <a href=https://github.com/VincentHardouin/comptrain-wod-history/blob/main/.github/workflows/deploy.yml>https://github.com/VincentHardouin/comptrain-wod-history/blob/main/.github/workflows/deploy.yml</a></p><p>Grâce à ces deux étapes nous n&rsquo;avons plus d&rsquo;API et de base de données qui tournent en permanence.
L&rsquo;hébergement et le déploiement dépendent désormais d&rsquo;uniquement GitHub.</p><h2 id=conclusion>Conclusion</h2><p>Face à cette problématique d&rsquo;historisation des WODs de Comptrain,
je propose donc <a href=https://wods.vincenthardouin.dev/>ce projet en solution</a>.
Nous avons pu voir qu&rsquo;avec un peu de remise en question la solution ne me coûte désormais plus d&rsquo;argent et elle peut
être utilisée par tout le monde.
Le code source est disponible à l&rsquo;adresse
suivante : <a href=https://github.com/VincentHardouin/comptrain-wod-history>https://github.com/VincentHardouin/comptrain-wod-history</a>
.</p><p>Nous pouvons aussi imaginer de nous passer de la base de données en nous basant sur un fichier JSON.
Pour ce qui est de l&rsquo;API, nous aurions pu
utiliser <a href=https://v3.nuxtjs.org/guide/features/server-routes>la solution de NuxtJS avec les servers</a>, mais je ne suis
pas à l&rsquo;aise avec ce couplage fort avec une solution.</p></div></main></div><footer></footer></body></html>